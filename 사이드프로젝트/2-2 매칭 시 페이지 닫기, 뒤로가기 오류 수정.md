ë§¤ì¹­ ì¤‘ ë§¤ì¹­ ì·¨ì†Œ ë²„íŠ¼ì´ ì•„ë‹Œ í˜ì´ì§€ë¥¼ ë‹«ê±°ë‚˜ ë’¤ë¡œê°€ê¸° ë“± ë¹„ì •ìƒì ìœ¼ë¡œ ë§¤ì¹­ í™”ë©´ì„ ì´íƒˆí•  ê²½ìš° ë§¤ì¹­ ëŒ€ê¸°ì—´ì—ì„œ ì‚­ì œë˜ëŠ” ë¡œì§ì´ ì—†ì—ˆë‹¤.
ì´ë¡œì¸í•´ ë§¤ì¹­ ëŒ€ê¸°ì—´ì´ ê¼¬ì´ëŠ” ìƒí™©ì´ ë°œìƒí–ˆë‹¤.
```
ex)
A : session-a
B : session-b

Aê°€ ë§¤ì¹­ ëŒ€ê¸°ì—´ ë“±ë¡
redis ë§¤ì¹­ ëŒ€ê¸°ì—´[session-a]
â†“
Aê°€ ë§¤ì¹­ ì¤‘ ë’¤ë¡œê°€ê¸° or ë¸Œë¼ìš°ì € ì¢…ë£Œ
redis ë§¤ì¹­ ëŒ€ê¸°ì—´[session-a] // ì—¬ì „íˆ ëŒ€ê¸°ì—´ì— Aì˜ ì„¸ì…˜ ID ì¡´ì¬
â†“
Bê°€ ë§¤ì¹­ ëŒ€ê¸°ì—´ ë“±ë¡
redis ë§¤ì¹­ ëŒ€ê¸°ì—´[session-a, session-b]
â†“
ë§¤ì¹­ ë¡œì§ì— ë”°ë¼ session-a, session-b ë§¤ì¹­
â†“
B í˜¼ìë§Œ ë§¤ì¹­
```

ë”°ë¼ì„œ ë¹„ì •ìƒì ìœ¼ë¡œ ë§¤ì¹­ í™”ë©´ì„ ë‚˜ê°€ë”ë¼ë„ ë§¤ì¹­ ëŒ€ê¸°ì—´ì—ì„œ ì •ì‚­ì ìœ¼ë¡œ ì‚­ì œë˜ë„ë¡ ë³€ê²½í–ˆë‹¤.
### cancel í•¨ìˆ˜ ìƒì„±(fetch + keepalive)
```javascript
const cancelMatchingKeepalive = useCallback((category: Category) => {
// ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
if (isCleaningUpRef.current) {
return;
}

isCleaningUpRef.current = true;  
if (!isValidCategory(category)) {
return;
}

const apiUrl = `${process.env.NEXT_PUBLIC_API_URL}/matching/cancel?category=${category.id}`;
// fetch + keepalive: true ì‚¬ìš©
// DELETE ìš”ì²­ ê°€ëŠ¥í•˜ê³ , ë°±ì—”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”!
fetch(apiUrl, {
method: 'DELETE',
credentials: 'include',
keepalive: true, // ğŸ”‘ í•µì‹¬: í˜ì´ì§€ê°€ ë‹«í˜€ë„ ìš”ì²­ ì™„ë£Œ ë³´ì¥
headers: {
'Content-Type': 'application/json'
}
})
.then(() => {
console.log('[Keepalive] ë§¤ì¹­ ì·¨ì†Œ ìš”ì²­ ì „ì†¡ ì„±ê³µ');
})
.catch((err) => {
console.error('[Keepalive] ë§¤ì¹­ ì·¨ì†Œ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨:', err);
});
}
```
ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ /cancel  apië¡œ ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í•˜ëŠ” í•¨ìˆ˜ë¡œ ê¸°ì¡´ì— ë°±ì—”ë“œì—ì„œ ì‚¬ìš©í•˜ë˜ urlì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í–ˆë‹¤.

ë˜í•œ fetch+keepaliveë¥¼ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ê°€ ë‹«íˆë”ë¼ê³  ì·¨ì†Œ ìš”ì²­ì´ ì™„ë£Œë˜ë„ë¡ ë³´ì¥í–ˆë‹¤.
```
# keepaliveë€?
ë¸Œë¼ìš°ì €ê°€ ì¢…ë£Œë˜ë”ë¼ë„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìš”ì²­ì„ ë³´ë‚´ë„ë¡ í•˜ëŠ” ì„¤ì •
ì•ˆì •ì„±ì„ ë” ë†’ì—¬ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.
```

### utils/device.ts ìƒì„±
ëª¨ë°”ì¼ ì „ìš© ì´ë²¤íŠ¸ utilì„ ìƒì„±í•´ì„œ page.tsxì— importí•˜ì—¬ ì‚¬ìš©í•œë‹¤.
```TypeScript
export const isMobileDevice = (): boolean => {
if (typeof window === 'undefined') {
return false;
}

// 1. User Agent ì²´í¬
const userAgent = navigator.userAgent.toLowerCase();
const mobileKeywords = [
'android',
'iphone',
'ipad',
'ipod',
'blackberry',
'windows phone',
'webos',
];

const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
// 2. í™”ë©´ í¬ê¸° ì²´í¬
const isSmallScreen = window.innerWidth <= 768;
// User Agentê°€ ëª¨ë°”ì¼ì´ê±°ë‚˜, í™”ë©´ì´ ì‘ì€ ê²½ìš°
return isMobileUA || isSmallScreen;
};
```
ìœ ì €ê°€ ì ‘ì†í•œ ê¸°ê¸°ë¥¼ ì²´í¬í•˜ì—¬ ëª¨ë°”ì¼ì¸ì§€ ì•„ë‹Œì§€ íŒë‹¨í•˜ëŠ” utilë¡œ ì¶”í›„ì— ë””ë°”ì´ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë¶„ê¸°ì²˜ë¦¬ í•˜ê¸° ìœ„í•¨
### BeforeUnloadEvent ì¶”ê°€(ë¸Œë¼ìš°ì € ì¢…ë£Œ, íƒ­ ë‹«ê¸°, ìƒˆë¡œê³ ì¹¨ ê°ì§€)
```TypeScript
useEffect(() => {
const isMobile = isMobileDevice();

const handleBeforeUnload = (_e: BeforeUnloadEvent) => {
// ë§¤ì¹­ ì¤‘ì´ê±°ë‚˜ ì±„íŒ… ì¤‘ì¼ ë•Œë§Œ ì‹¤í–‰
if (appState.currentScreen === 'matching' || appState.currentScreen === 'chat') {
if (activeCategory && isValidCategory(activeCategory)) {
cancelMatchingKeepalive(activeCategory);
}
disconnectWebSocket();
_e.preventDefault();
_e.returnValue = 'ë§¤ì¹­ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
}
};
```
BeforeUnloadEventê°€ ë¸Œë¼ìš°ì € ì¢…ë£Œ, íƒ­ ë‹«ê¸°, ìƒˆë¡œê³ ì¹¨ ì´ë²¤íŠ¸ë¥¼ ê°ì§€
í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ì—¬ ëŒ€ê¸°ì—´ ë“±ë¡ ì·¨ì†Œ ìš”ì²­ì„ ë³´ë‚´ë©° prevent ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ í˜ì´ì§€ ì´íƒˆ ìœ ë¬´ë¥¼ ë¬»ëŠ” ëª¨ë‹¬ì„ ë„ìš´ë‹¤.

BeforeUnloadEventëŠ” ê±°ì˜ ë°ìŠ¤í¬í†± ì „ìš©ì´ë©° ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì‹ ë¢°í•˜ê¸° ì–´ë ¤ì›Œ ëª¨ë°”ì¼ ì „ìš© ì´ë²¤íŠ¸ë¥¼ ë”°ë¡œ ì¶”ê°€ í–ˆë‹¤.
### pagehide ì´ë²¤íŠ¸ ì¶”ê°€
```TypeScript
// pagehide ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ëŒ€ì‘ - iOS Safari)
const handlePageHide = () => {
if (appState.currentScreen === 'matching' || appState.currentScreen === 'chat') {
console.log('[PageHide] í˜ì´ì§€ ìˆ¨ê¹€ ê°ì§€, ë§¤ì¹­ ì·¨ì†Œ ì¤‘...');
if (activeCategory && isValidCategory(activeCategory)) {
cancelMatchingKeepalive(activeCategory);
}
disconnectWebSocket();
}
};

```
ëª¨ë°”ì¼ ëŒ€ì‘ìœ¼ë¡œ pagehide ì´ë²¤íŠ¸ ì¶”ê°€
pagehideëŠ” í˜ì´ì§€ê°€ ì‚¬ìš©ì ë·°ì—ì„œ ìˆ¨ê²¨ì§ˆ ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ë¡œ íƒ­ ë‹«ê¸°, ë¸Œë¼ìš°ì € ë‹«ê¸°, ë’¤ë¡œê°€ê¸° ë“± ì´ë²¤íŠ¸ë¥¼ ê°ì§€
í•´ë‹¹ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ëŒ€ê¸°ì—´ ë“±ë¡ ì·¨ì†Œë¥¼ ìš”ì²­í•˜ê²Œ ëœë‹¤.
### visibilitychange ì´ë²¤íŠ¸ ì¶”ê°€
``` TypeScript
// visibilitychange ì´ë²¤íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ ì „í™˜ - ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
const handleVisibilityChange = () => {
if (document.visibilityState === 'hidden') {
if (appState.currentScreen === 'matching' || appState.currentScreen === 'chat') {
console.log('[VisibilityChange] í˜ì´ì§€ ìˆ¨ê¹€, ë§¤ì¹­ ì·¨ì†Œ ì¤‘...');
if (activeCategory && isValidCategory(activeCategory)) {
cancelMatchingKeepalive(activeCategory);
}
}
} else {
// ë‹¤ì‹œ ë³´ì¼ ë•Œ cleanup flag ë¦¬ì…‹
isCleaningUpRef.current = false;
}
};

window.addEventListener('beforeunload', handleBeforeUnload);
window.addEventListener('pagehide', handlePageHide);
document.addEventListener('visibilitychange', handleVisibilityChange);

return () => {
window.removeEventListener('beforeunload', handleBeforeUnload);
window.removeEventListener('pagehide', handlePageHide);
document.removeEventListener('visibilitychange', handleVisibilityChange);
};
}, [appState.currentScreen, activeCategory, cancelMatchingKeepalive]);

```
visibilitychangeëŠ” í˜ì´ì§€ì˜ ê°€ì‹œì„± ìƒíƒœê°€ ë³€ê²½ë  ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸
ëª¨ë°”ì¼ì—ì„œ ë‹¤ë¥¸ íƒ­ ì „í™˜, í™ˆ ë²„íŠ¼ ë“± ë·°ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ê³  ë°±ê·¸ë¼ìš´ë“œë¡œ ì „í™˜ë˜ë©´ ê°ì§€í•˜ëŠ” ì´ë²¤íŠ¸ì´ë‹¤.
ë§ˆì°¬ê°€ì§€ë¡œ í•´ë‹¹ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ëŒ€ê¸°ì—´ ë“±ë¡ ì·¨ì†Œë¥¼ ìš”ì²­í•œë‹¤.

### ì´ë²¤íŠ¸ ë¶„ê¸° ì²˜ë¦¬
```TypeScript
window.addEventListener('beforeunload', handleBeforeUnload);
if(isMobile){
window.addEventListener('pagehide', handlePageHide);
document.addEventListener('visibilitychange', handleVisibilityChange);
}
return () => {
window.removeEventListener('beforeunload', handleBeforeUnload);
if(isMobile){
window.removeEventListener('pagehide', handlePageHide);
document.removeEventListener('visibilitychange', handleVisibilityChange);
}
};
}, [appState.currentScreen, activeCategory, cancelMatchingKeepalive]);
```
beforeunloadëŠ” ê³µí†µ ì ìš©
pagehide, visibilitychangeëŠ” ëª¨ë°”ì¼ì¸ ê²½ìš°ì—ë§Œ ì ìš©

### popstate ì¶”ê°€(ë’¤ë¡œê°€ê¸° ê°ì§€)
```TypeScript
useEffect(() => {
const handlePopState = async () => {
console.log('[PopState] ë’¤ë¡œê°€ê¸° ê°ì§€');
if (appState.currentScreen === 'matching' || appState.currentScreen === 'chat') {
// ë’¤ë¡œê°€ê¸° ì‹œ ë§¤ì¹­ ì·¨ì†Œ
await handleBackToMain();
}
};
window.addEventListener('popstate', handlePopState);
return () => {
window.removeEventListener('popstate', handlePopState);
};
}, [appState.currentScreen, handleBackToMain]); // handleBackToMain ì˜ì¡´ì„± ì¶”ê°€

```
popstate ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì—¬ ë’¤ë¡œê°€ê¸°ë¥¼ ê°ì§€í•˜ê³  handleBackToMainì„ í˜¸ì¶œí•˜ì—¬
ë©”ì¸í˜ì´ì§€ ì´ë™ ë° ëŒ€ê¸°ì—´ ì‚­ì œë¥¼ ì‹¤í–‰

### í…ŒìŠ¤íŠ¸
![[Pasted image 20251208171301.png]]
ë’¤ë¡œ ê°€ê¸° í´ë¦­ ì‹œ prevent ì´ë²¤íŠ¸ë¡œ ëª¨ë‹¬ ì¶œë ¥
ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œì—ë„ í•´ë‹¹ í™”ë©´ì´ ì¶œë ¥ë˜ì—ˆë‹¤.

#### ë ˆë””ìŠ¤ ë°ì´í„° í™•ì¸
![[Pasted image 20251208171723.png|1000]]
ë§¤ì¹­ ìš”ì²­ í›„ redisì— ë§¤ì¹­ í ìƒì„± ë° sessionID ë“±ë¡

![[Pasted image 20251208171803.png]]
ë’¤ë¡œ ê°€ê¸°, ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ë§¤ì¹­ íê°€ ì‚¬ë¼ì§„ ê²ƒì„ í™•ì¸