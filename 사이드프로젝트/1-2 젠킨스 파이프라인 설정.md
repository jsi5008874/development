
### Credential ì„¤ì •
credentialì€ ë„ì»¤ í—ˆë¸Œ, ê¹ƒ í—ˆë¸Œ ë“± ì  í‚¨ìŠ¤ê°€ ë¹Œë“œí•˜ê³  ë°°í¬í•˜ëŠ” ê³¼ì •ì—ì„œ í•„ìš”í•œ ë¡œê·¸ì¸ ì •ë³´ë“¤ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

ì„¤ì •ì€ Jenkins ê´€ë¦¬ > Security > Credentialë¡œ ì§„ì…
![[Pasted image 20250529235812.png]]

ì´í›„ system > global credential > ìš°ì¸¡ ìƒë‹¨ì— add credential

ì—¬ê¸°ì„œ ë„ì»¤ í—ˆë¸Œì™€ git hub ë“± ì¸ì¦ ì •ë³´ë¥¼ ê¸°ì…
https://velog.io/@uiop5487/Jenkins-CICD-Pipeline-%EA%B5%AC%EC%B6%95
í•´ë‹¹ ë¸”ë¡œê·¸ ì°¸ê³ 

## pipeline êµ¬ì„±
ì•„ì´í…œ ì ‘ì†(Annoni-App-Prod) > êµ¬ì„±ìœ¼ë¡œ ì ‘ì†

ìë™ ë¹Œë“œë³´ë‹¤ëŠ” ìˆ˜ë™ë¹Œë“œê°€ ë” ì•ˆì „í•˜ë‹¤ê³  ìƒê°í•´ì„œ í´ë§ì´ë‚˜ ì›¹í›… ë°©ì‹ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

![[Pasted image 20250529235718.png]]
ê·¸ë˜ì„œ íŠ¸ë¦¬ê±°ëŠ” ì•„ë¬´ê²ƒë„ ì„¤ì •í•˜ì§€ ì•ŠìŒ

íšŒì‚¬ì—ì„œ ì²˜ëŸ¼ ì§ì ‘ ì  í‚¨ìŠ¤ì—ì„œ ë¹Œë“œë¥¼ ëˆŒëŸ¬ì•¼ ë¹Œë“œê°€ ì‹œì‘ë¨

### ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
```
pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO = 'ghcr.io/anonichat/app/anonichat'
        DOCKER_IMAGE_TAG = '${BUILD_NUMBER}'
        DOCKER_LATEST_TAG = 'latest'
        DOCKER_HUB_CREDENTIALS = 'gitPackage'
        CONTAINER_NAME = 'anonichat'
        CONTAINER_PORT = '8000:8080'
    }

    stages {
        stage('1. Git Clone') {
            steps {
                echo 'ğŸ“‚ GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°...'
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/prod']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/AnoniChat/App.git',
                        credentialsId: 'githubRepository'
                    ]]
                ])
                sh 'git log --oneline -5'
            }
        }

        stage('2. Build') {
		    steps {
		        echo 'ğŸ”¨ anonichat ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
		        script {
		            if (fileExists('gradlew')) {
		                sh 'chmod +x ./gradlew'
		                sh './gradlew clean build -x test'
		            } else {
		                error('gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Gradle í”„ë¡œì íŠ¸ì¸ì§€ í™•ì¸í•˜ì„¸ìš”!')
					}
				}
			}
		}

        stage('3. Test') {
		    steps {
		        echo 'ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
		        sh './gradlew test'
		    }
		    post {
		        always {
		            junit 'build/test-results/test/*.xml'
		        }
		    }
		}

        stage('4. Docker Image Build') {
		    steps {
		        echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
		        script {
		            // Gradle ë¹Œë“œ ê²°ê³¼ JAR íŒŒì¼ ì°¾ê¸°
		            def jarFile = sh(
		                script: 'find build/libs -name "*.jar" | grep -v plain', 
		                returnStdout: true
		            ).trim()
		            
		            if (jarFile) {
		                echo "JAR íŒŒì¼ ë°œê²¬: ${jarFile}"
		                sh """
		                docker build -t ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG} .
		                docker tag ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG} ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}
		                """
		            } else {
		                error('JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')
		            }
		        }
		    }
		}

        stage('5. Docker Image Push') {
            steps {
                echo 'ğŸ“¤ GHCRì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘...'
                script {
                    withCredentials([usernamePassword(credentialsId: "githubPackage", 
                                                    passwordVariable: 'DOCKER_PASSWORD', 
                                                    usernameVariable: 'DOCKER_USERNAME')]) {
                        sh """
                        echo ${DOCKER_PASSWORD} | docker login ghcr.io -u ${DOCKER_USERNAME} --password-stdin
                        docker push ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG}
                        docker push ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}
                        docker logout
                        """
                    }
                }
                echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"
            }
        }

        stage('6. Deploy') {
            steps {
                echo 'ğŸš€ ìµœì‹  ì´ë¯¸ì§€ë¡œ ë°°í¬ ì¤‘...'
                script {
                    try {
                        sh "docker stop ${CONTAINER_NAME} || true"
                        sh "docker rm ${CONTAINER_NAME} || true"
                        sh "docker rmi ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG} || true"
                        sh "docker pull ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}"
                        sh """
                        docker run -d \
                          --name ${CONTAINER_NAME} \
                          --restart always \
                          -p ${CONTAINER_PORT} \
                          ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}
                        """
                        sh "sleep 10"
                        sh "docker ps | grep ${CONTAINER_NAME}"
                    } catch (Exception e) {
                        echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                        throw e
                    }
                }
            }
        }
    }

    post {
    always {
        script {
            node {  // node context ì¶”ê°€
                echo 'ğŸ§¹ ë¹Œë“œ í›„ ì •ë¦¬ ì‘ì—…...'
                sh 'docker image prune -f || true'
            }
        }
    }
    success {
        echo 'ğŸ‰ CI/CD íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
    }
    failure {
        echo 'âŒ CI/CD íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    }
}
}
```

stage ë³„ë¡œ í™•ì¸í•´ë³´ì

**í™˜ê²½ë³€ìˆ˜ ì„¤ì •**
```yml
agent any

    environment {
        DOCKER_HUB_REPO = 'ghcr.io/anonichat/app/anonichat' ##ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
        DOCKER_IMAGE_TAG = '${BUILD_NUMBER}'  ## ì´ë¯¸ì§€ íƒœê·¸ ìë™ ë„˜ë²„ë§
        DOCKER_LATEST_TAG = 'latest'  ## ê°€ì¥ ìµœê·¼ íƒœê·¸ ë„˜ë²„ë¥¼ í•­ë‹¹
        DOCKER_HUB_CREDENTIALS = 'gitPackage' ## ì  í‚¨ìŠ¤ credential ì´ë¦„
        CONTAINER_NAME = 'anonichat'  ## ì»¨í…Œì´ë„ˆ ì´ë¦„
        CONTAINER_PORT = '8000:8080' ## ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  í¬íŠ¸ í˜¸ìŠ¤íŠ¸ í¬íŠ¸:ì»¨í…Œì´ë„ˆ í¬íŠ¸
    }
```
íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ë“¤ì´ë‹¤.
${í™˜ê²½ë³€ìˆ˜ëª…}ì„ ì‚¬ìš©í•˜ë©´ ìœ„ì—ì„œ ì„¤ì •í•œ ê°’ì´ ë“¤ì–´ê°€ëŠ” ë°©ì‹ì´ë‹¤.

CONTAINER_PORT = '8000:8080' ## ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  í¬íŠ¸ í˜¸ìŠ¤íŠ¸ í¬íŠ¸:ì»¨í…Œì´ë„ˆ í¬íŠ¸
í˜¸ìŠ¤íŠ¸ í¬íŠ¸ëŠ” ì‹¤ì œ ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ì´ê³  ì»¨í…Œì´ë„ˆ í¬íŠ¸ëŠ” ì•±ì´ ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰ë˜ëŠ” í¬íŠ¸ì´ë‹¤.

ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” 8000 í¬íŠ¸ë¡œ ìš”ì²­ì„ ë°›ìœ¼ë©´ ë„ì»¤ì—ì„œ 8080ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì•±ì´ ì‹¤í–‰ë˜ê³  ìˆëŠ” 8080í¬íŠ¸ë¡œ ì „ë‹¬í•´ì£¼ëŠ” ë°©ì‹ì´ë‹¤.

ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì— ipì£¼ì†Œ:8000ìœ¼ë¡œ ì ‘ì†í•˜ë©´
ì¸ìŠ¤í„´ìŠ¤ 8000 > ë„ì»¤ 8080ìœ¼ë¡œ ë³€í™˜ > ì»¨í…Œì´ë„ˆ 8080ìœ¼ë¡œ ìš”ì²­ ì ‘ìˆ˜ì˜ íë¦„ì´ë‹¤.

**stage 1. git clone**
```yml
stage('1. Git Clone') {
            steps {
                echo 'ğŸ“‚ GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°...'
                checkout([$class: 'GitSCM',    ## ì  í‚¨ìŠ¤ì˜ git í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš©
                    branches: [[name: '*/prod']],  ## ë¸Œëœì¹˜ ëª…
                    userRemoteConfigs: [[
                        url: 'https://github.com/AnoniChat/App.git',  ## git url
                        credentialsId: 'githubRepository'. ## git ì ‘ì† ê´€ë ¨ credential
                    ]]
                ])
                sh 'git log --oneline -5'. ## ìµœê·¼ ì»¤ë°‹ ê¸°ë¡ 5ê°œ ë¡œê·¸ ì¶œë ¥
            }
        }
```
git cloneì€ íŠ¹ë³„í•œ ê²ƒ ì—†ë‹¤.
git urlê³¼ github credentialë§Œ ì˜ ì„¤ì •í•˜ë©´ ì´ìƒì—†ì´ cloneì„ í•´ì˜¨ë‹¤.


**stage 2. build**
```yml
stage('2. Build') {
		    steps {
		        echo 'ğŸ”¨ anonichat ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
		        script {
		            if (fileExists('gradlew')) {
		                sh 'chmod +x ./gradlew'  ## gradlew ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
		                sh './gradlew clean build -x test' ## í…ŒìŠ¤íŠ¸ ì œì™¸ ë¹Œë“œ
		            } else {
		                error('gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Gradle í”„ë¡œì íŠ¸ì¸ì§€ í™•ì¸í•˜ì„¸ìš”!')
					}
				}
			}
		}
```
gitì—ì„œ ê°€ì ¸ì˜¨ ì½”ë“œë¥¼ gradleë¡œ ë¹Œë“œí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì´ë‹¤.

chmod +xëŠ” gradlew íŒŒì¼ì˜ ì‹¤í–‰ê¶Œí•œì„ ì£¼ëŠ” ê²ƒìœ¼ë¡œ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•¨ì´ë‹¤.
githubì— ìˆëŠ” gradlewë¥¼ ì‹¤í–‰ì‹œì¼œ ì½”ë“œë¥¼ ë¹Œë“œí•˜ëŠ” ê³¼ì •ì´ë‹¤.

**stage 3. test**
```yml
stage('3. Test') {
		    steps {
		        echo 'ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
		        sh './gradlew test'
		    }
		    post {
		        always {
		            junit 'build/test-results/test/*.xml'
		        }
		    }
		}
```
í…ŒìŠ¤íŠ¸ ë‹¨ê³„ë¡œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¤ê³  ì´ìƒì´ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„ì´ë‹¤.

ê·¸ë¦¬ê³  post alwaysì˜ ì½”ë“œëŠ” ì  í‚¨ìŠ¤ ì•„ì´í…œë³„ í˜ì´ì§€ì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ í˜„í™©ì„ ë³´ì—¬ì¤€ë‹¤.
![[Pasted image 20250603200508.png]]

**stage 4. docker image build**
```yml
stage('4. Docker Image Build') {
		    steps {
		        echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
		        script {
		            // Gradle ë¹Œë“œ ê²°ê³¼ JAR íŒŒì¼ ì°¾ê¸°
		            def jarFile = sh(
		                script: 'find build/libs -name "*.jar" | grep -v plain', ##jaríŒŒì¼ ì°¾ê¸°
		                returnStdout: true
		            ).trim()
		            
		            if (jarFile) {
		                echo "JAR íŒŒì¼ ë°œê²¬: ${jarFile}"
		                sh """
		                docker build -t ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG} . ## ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
		                docker tag ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG}   ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG} ##ìƒì„±ëœ ë„ì»¤ ì´ë¯¸ì§€ì— íƒœê·¸ ë¶™ì´ê¸°
		                """
		            } else {
		                error('JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')
		            }
		        }
		    }
		}
```
ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•´ì„œ íƒœê·¸ë¥¼ ë¶™ì´ëŠ” ë‹¨ê³„ë¡œ íŠ¹ë³„í•œ ê²ƒì€ ì—†ë‹¤.

**stage 5. ë„ì»¤ ì´ë¯¸ì§€ í‘¸ì‹œ**
```yml
stage('5. Docker Image Push') {
            steps {
                echo 'ğŸ“¤ GHCRì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘...'
                script {
                    withCredentials([usernamePassword(credentialsId: "githubPackage", 
                                                    passwordVariable: 'DOCKER_PASSWORD', 
                                                    usernameVariable: 'DOCKER_USERNAME')]) {
                        sh """                      ## ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ì†
                        echo ${DOCKER_PASSWORD} | docker login ghcr.io -u ${DOCKER_USERNAME} --password-stdin ## íŒ¨ìŠ¤ì›Œë“œ ë¡œê·¸ì— ì•ˆë‚¨ë„ë¡ ëª…ì‹œ
                        docker push ${DOCKER_HUB_REPO}:${DOCKER_IMAGE_TAG}
                        docker push ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}
                        docker logout
                        """
                    }
                }
                echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ!"
            }
        }
```
ì  í‚¨ìŠ¤ credentialì— ì €ì¥í•´ë‘” ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ì† ì •ë³´ë¥¼ í™œìš©í•´ ìƒˆë¡œ ìƒì„±í•œ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ í‘¸ì‰¬í•˜ëŠ” ê³¼ì •


**stage 6. ë°°í¬**
```yml
stage('6. Deploy') {
            steps {
                echo 'ğŸš€ ìµœì‹  ì´ë¯¸ì§€ë¡œ ë°°í¬ ì¤‘...'
                script {
                    try {
                        sh "docker stop ${CONTAINER_NAME} || true" ## ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                        sh "docker rm ${CONTAINER_NAME} || true" ## ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
                        sh "docker rmi ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG} || true" ##ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
                        sh "docker pull ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG}" ## ì‹ ê·œ ì´ë¯¸ì§€ pull
                        sh """
                        docker run -d \
                          --name ${CONTAINER_NAME} \
                          --restart always \
                          -p ${CONTAINER_PORT} \
                          ${DOCKER_HUB_REPO}:${DOCKER_LATEST_TAG} ## ì‹ ê·œ ì´ë¯¸ì§€ ì‹¤í–‰
                        """
                        sh "sleep 10"  ## 10ì´ˆ ëŒ€ê¸°
                        sh "docker ps | grep ${CONTAINER_NAME}" ## ì»¨í…Œì´ë„ˆ ì‹¤í–‰ìƒíƒœ í™•ì¸
                    } catch (Exception e) {
                        echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                        throw e
                    }
                }
            }
        }
```
ê¸°ì¡´ì— ì‹¤í–‰ì¤‘ì´ë˜ ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ pullë¡œ ë°›ì•„ì™€ì„œ ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ëŠ” ê³¼ì •

### ë¹Œë“œ ëŒë ¤ë³´ê¸°
![[Pasted image 20250603201518.png]]
íŒŒì´í”„ë¼ì¸ì´ ì˜ ì‹¤í–‰ëœë‹¤.

í…ŒìŠ¤íŠ¸ ê²¸ main.htmlì„ ë³€ê²½í•´ì„œ gitì— í‘¸ì‰¬í•˜ê³  íŒŒì´í”„ë¼ì¸ì´ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì

**ë³€ê²½ ì „**
![[Pasted image 20250603190003.png]]

**ë³€ê²½ í›„**
![[Pasted image 20250603190305.png]]

htmlì— "ì¶”ê°€ í…ŒìŠ¤íŠ¸"ë¼ëŠ” ë¬¸ìì—´ì„ ì¶”ê°€í•´ì„œ gitì— í‘¸ì‰¬ë¥¼ í–ˆë‹¤.
ì´í›„ì— ì  í‚¨ìŠ¤ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ë¹Œë“œë¥¼ í–ˆëŠ”ë° ë³€ê²½ì‚¬í•­ì´ ì˜ ì ìš©ë˜ì—ˆë‹¤.
ì´ê²ƒìœ¼ë¡œ Jenkins CI/CDëŠ” ë¬¸ì œ ì—†ì´ ì‘ë™í•˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.