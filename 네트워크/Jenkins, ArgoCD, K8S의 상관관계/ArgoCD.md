GitOps방식의 지속적 배포(CD)도구로 주로 쿠버네티스 환경에서 애플리케이션 배포를 자동화하고 관리

[[GitOps]]

### ArgoCD의 주요 역할
- **선언적 배포 관리**:
    - Git 저장소에 정의된 매니페스트와 쿠버네티스 클러스터의 실제 상태를 일치
    - 이상적인 상태(Git에 정의된 상태)와 실제 상태 간의 차이를 감지하고 해결
- **자동 동기화**:
    - Git 저장소의 변경사항을 자동으로 감지하고 쿠버네티스 클러스터에 적용
    - 수동 개입 없이 배포 프로세스를 자동화
- **다중 클러스터 관리**:
    - 여러 쿠버네티스 클러스터를 중앙에서 관리
    - 개발, 스테이징, 프로덕션과 같은 여러 환경에 일관된 배포를 제공
- **배포 시각화 및 모니터링**:
    - 웹 UI를 통해 배포 상태를 시각적으로 확인
    - 배포 이력과 버전 간 차이를 추적

### ArgoCD의 실행 흐름
- **초기 설정**:
    - ArgoCD는 쿠버네티스 클러스터에 설치
    - Git 저장소와 연결되어 매니페스트 파일을 감시
    - 애플리케이션(Application)이라는 리소스를 정의하여 어떤 Git 저장소의 어떤 경로에 있는 매니페스트를 어떤 클러스터에 배포할지 지정
- **변경 감지**:
    - ArgoCD는 정기적으로 Git 저장소를 폴링하여 변경사항을 확인
    - 젠킨스가 새로운 이미지 태그로 매니페스트를 업데이트하면, ArgoCD는 이 변경을 감지
- **상태 비교**:
    - Git 저장소의 매니페스트(원하는 상태)와 쿠버네티스 클러스터의 실제 상태를 비교
    - 차이가 있으면 동기화가 필요하다고 판단
- **동기화 실행**:
    - 설정에 따라 자동 또는 수동으로 동기화 프로세스를 시작
    - 쿠버네티스 API를 통해 클러스터에 변경사항을 적용
- **건강 상태 확인**:
    - 배포된 애플리케이션의 건강 상태를 모니터링
    - Deployment, StatefulSet, Service 등 리소스의 상태를 확인
- **롤백 관리**:
    - 문제가 발생하면 이전 버전으로 롤백
    - Git 저장소에서 이전 커밋으로 되돌리면 ArgoCD가 이를 감지하여 클러스터에도 적용



## 초기 설정
### ArgoCD 설치
ArgoCD를 쿠버네티스 환경 내부에 애플리케이션으로 배포를 하는 것
쿠버네티스 자체가 다양한 어플리케이션을 실행할 수 있는 플랫폼이고 ArgoCD 역시 컨테이너화 된 어플리케이션이다.

그래서 ArgoCD의 구성 요소들(서버, 레포지토리 서버 등)이 쿠버네티스에서 실행된다.

### ArgoCD의 변경 감지 방법
ArgoCD도 쿠버네티스에서 실행되는 어플리케이션이기 때문에 매니페스트 파일을 가지고 있다.

```text
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-spring-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-org/kubernetes-manifests.git
    targetRevision: HEAD  # 또는 특정 브랜치/태그
    path: apps/spring-boot  # 매니페스트가 있는 경로
  destination:
    server: https://kubernetes.default.svc  # 쿠버네티스 API 서버 URL
    namespace: spring-boot-prod  # 배포할 네임스페이스
  syncPolicy:
    automated:
      prune: true  # 삭제된 리소스도 클러스터에서 제거
      selfHeal: true  # 직접 클러스터 변경 시 자동 복원
    syncOptions:
      - CreateNamespace=true  # 네임스페이스가 없으면 생성
  revisionHistoryLimit: 10  # 저장할 리비전 히스토리 개수
```
**이처럼 매니페스트에 감시할 저장소, 특정 브랜치, 감시할 매니페스트의 경로 등을 설정하여 git의 변경을 감지한다.**


## ArgoCD의 어플리케이션 상태 비교 방법

1. Git 저장소에 정의된 매니페스트 파일 수집
2. 쿠버네티스 API 서버의 현재 클러스터에 배포된 리소스의 실제 상태 수집
3. 두 정보를 메모리에 로드하여 각각의 리소스 트리를 구성
4. 리소스 간의 차이를 차이점 계산 알고리즘으로 계산
5. 각 리소스의 스펙을 Json or YAML 구조로 비교
6. 중요 필드들(spec, data, rules 등)의 차이점을 계산
7. 비교 결과에 따른 애플리케이션 상태 평가(Synced > 일치, OutOfSync > 차이 감지, UnKnown > 상태 결정 불가)

 **리소스 비교는 단순한 텍스트 비교가 아닌 쿠버네티스 리소스 구조와 특성을 이용해 비교한다.**


## ArgoCD의 동기화 작업

### 동기화 작업 방식
자동 동기화 : ArgoCD Application 리소스(매니페스트)에 자동 동기화 옵션이 활성화된 경우
			변경이 감지되면 자동으로 동기화

수동 동기화 : 자동 동기화 비활성화된 경우 UI 또는 CLI 등으로 수동 동기화 진행
			 회사에서 ArgoCD UI에서 진행하는 방식(Sync 버튼 클릭)

### 동기화 실행 방식
1. 동기화 계획 수립 : 상태 비교 결과를 기반으로 생성/수정/삭제할 리소스를 선택 및 리소스 간의 종속성을 고려하여 적용 순서 결정(ex. NameSpace > ConfigMap > Deployment)
2. 매니페스트 전처리 : Helm, Kustomize 등 템플릿 도구로 작성된 매니페스트를 최종 YML로 변환
3. 리소스 적용 : 쿠버네티스 API를 통해 리소스를 순차적으로 적용
4. 대기 및 상태 확인 : 리소스 적용 후 원하는 상태 도달까지 대기, 이후 상태 확인
5. 후크 실행 : 배포 전/후 특별한 작업을 실행하는 동기화 후크 지원(슬랙 알림 등)
6. 웨이브 실행 : 복잡한 애플리케이션은 여러 웨이브로 나누어 순차적으로 동기화



**동기화까지 한 후에는 애플리케이션의 상태를 모니터링하면 된다.**


## ArgoCD 최종 정리

ArgoCD는 배포를 위한 수단이다.
애플리케이션을 실행하는 쿠버네티스와는 다른 레벨이며 지속적인 배포를 위한 도구로 생각해야한다.

전통적인 CI/CD 방식과 다르게 Pull 방식의 GitOps의 방법론을 활용하여 더욱 높은 안정성을 보장한다.

**ArgoCD 또한 쿠버네티스에서 실행되는 어플리케이션이며 git과 연동되어 매니페스트의 변경이 감지되면**
**쿠버네티스에게 전달하여 애플리케이션의 최신 버전이 유지되도록 도와주는 역할을 한다.**

